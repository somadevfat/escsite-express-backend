# アーキテクチャ上の判断（決定ログ）

## 2025-08-10: OpenAPI の検証を一時的に緩和する

- 背景
  - PHP/Laravel から Express + express-openapi-validator へ移行中。
  - 既存の OpenAPI ドキュメント（`docs/` 配下）は、生成系ツールでは受け入れられる記述が含まれている一方で、厳密な実行時バリデータ（Ajv）ではエラーとなる箇所がある（例: `properties` 直下に `$ref` など）。

- 決定
  - 当面はドキュメントを変更せず、開発速度を優先する。
  - バリデータ設定（`src/index.ts`）を以下とする：
    - `validateApiSpec: false`（起動時の仕様書の厳密検証はスキップ）
    - `validateRequests: true`（入力のバリデーションは維持）
    - `validateResponses: false`（出力のバリデーションは一時的に無効化）

- 理由
  - まずは動かしながら機能実装を進めたい。
  - リクエストの保護は維持しつつ、レスポンス/仕様の厳密性は後で段階的に整える方針。

- 影響
  - 仕様の不整合は起動時に検出されない。
  - レスポンスの型ずれは自動検出されない（品質担保が一時的に弱くなる）。

- 元に戻す計画（段階的に厳格化）
  1. `docs/responses/**` の記述を正規化（`properties` 直下に `$ref` を置かない。スキーマ直下で `$ref` するか、プロパティにラップして参照）。
  2. `schemas/models/**` の `required` と `properties` の不整合を解消（例: `User.yml` は `required` にある `status` を定義するか、`required` から外す）。
  3. `validateResponses: true` に戻す。
  4. `validateApiSpec: true` に戻す。

---

### 記録目的（なぜ残すか）
- 暫定措置の合意内容を明文化し、チーム内の認識ずれを防ぐため。
- いつ・誰が・何を・なぜ緩めたかをあとから追跡できるようにするため。
- ロールバック（厳格化）条件を明示し、恒久化を防止するため。

### 運用ルール（当面の扱い）
- 既存の `docs/` は原則変更しない。新規エンドポイントは可能な範囲で標準準拠に寄せる。
- 入力（リクエスト）仕様は厳守するため `validateRequests: true` は維持する。
- 仕様修正や整備を実施した場合は、本ドキュメント（決定ログ）を更新する。

### ロールバック条件（戻すトリガー）
- `docs/responses/**` の `$ref` 配置が標準準拠へ修正済み。
- `schemas/models/**` の `required` と `properties` が整合している（例: `User.status`）。
- 主要エンドポイントの疎通とレスポンス形の確認が完了している。

### 責任/期限（目安）
- 責任者: （TBD）
- 厳格化の目安時期: （TBD）必要な対応量の見積もり後に設定。
